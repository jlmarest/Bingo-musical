<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Bingo musical Spotify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, Arial; margin: 20px; }
    button { padding: 10px 16px; margin: 8px 0; }
    pre { background: #f5f5f5; padding: 10px; max-height: 200px; overflow:auto; }
    .row { margin: 8px 0; }
  </style>
</head>
<body>
  <h1>Bingo musical</h1>
  <div class="row">
    <label>Client ID de Spotify: <input id="clientId" placeholder="tu_client_id" /></label>
  </div>
  <div class="row">
    <label>Redirect URI: <input id="redirectUri" placeholder="https://tusitio.com/callback" /></label>
  </div>
  <button id="loginBtn">Iniciar sesión en Spotify</button>
  <div class="row">
    <label>Playlist ID (spotify:playlist:... o URL): <input id="playlistId" /></label>
  </div>
  <div class="row">
    <input type="file" id="segmentsCsv" accept=".csv"/>
    <small>(Opcional) CSV con segmentos: track_id,start_sec,end_sec</small>
  </div>
  <button id="loadPlaylistBtn">Cargar playlist</button>
  <button id="startBingoBtn">Empezar bingo</button>
  <button id="downloadLogBtn">Descargar log (CSV)</button>

  <pre id="log"></pre>

  <!-- SDK de Spotify -->
  https://sdk.scdn.co/spotify-player.js</script>
  <script>
    let token = null;
    let deviceId = null;
    let player = null;
    let tracks = [];        // [{id, name, artists}]
    let segments = {};      // {track_id: {start: s, end: s}}
    let logRows = [];       // [{ts, track, artist, start, end}]

    function appendLog(msg) {
      const el = document.getElementById('log');
      el.textContent += msg + "\\n";
    }

    function parsePlaylistId(input) {
      // Acepta URL de Spotify o ID
      try {
        if (input.includes("playlist")) {
          const url = new URL(input);
          const parts = url.pathname.split('/');
          const idx = parts.findIndex(p => p === 'playlist');
          if (idx >= 0 && parts[idx+1]) return parts[idx+1];
        }
      } catch {}
      return input.trim();
    }

    // OAuth implícito (simplificado) — en producción usa PKCE.
    function login() {
      const clientId = document.getElementById('clientId').value.trim();
      const redirectUri = document.getElementById('redirectUri').value.trim();
      const scopes = [
        'streaming',
        'user-read-email',
        'user-read-private',
        'playlist-read-private',
        'playlist-read-collaborative',
        'user-modify-playback-state',
        'user-read-playback-state'
      ].join(' ');
      const url = 'https://accounts.spotify.com/authorize' +
        `?client_id=${encodeURIComponent(clientId)}` +
        `&response_type=token` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&scope=${encodeURIComponent(scopes)}`;
      window.location.href = url;
    }

    // Recupera token del hash tras redirección
    function readTokenFromHash() {
      if (location.hash && location.hash.includes('access_token')) {
        const params = new URLSearchParams(location.hash.slice(1));
        token = params.get('access_token');
        appendLog('Autenticado.');
      }
    }

    // Inicializa el Web Playback SDK
    window.onSpotifyWebPlaybackSDKReady = () => {
      player = new Spotify.Player({
        name: 'Bingo musical',
        getOAuthToken: cb => { cb(token); },
        volume: 0.8
      });

      player.addListener('ready', ({ device_id }) => {
        deviceId = device_id;
        appendLog('Dispositivo listo: ' + deviceId);
      });

      player.addListener('initialization_error', ({ message }) => appendLog('Init error: ' + message));
      player.addListener('authentication_error', ({ message }) => appendLog('Auth error: ' + message));
      player.addListener('account_error', ({ message }) => appendLog('Account error: ' + message));
      player.addListener('playback_error', ({ message }) => appendLog('Playback error: ' + message));

      player.connect();
    };

    async function spotifyApi(path, method='GET', body=null) {
      const res = await fetch(`https://api.spotify.com/v1/${path}`, {
        method,
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : null
      });
      if (!res.ok) throw new Error(`API ${path} => ${res.status}`);
      return res.json();
    }

    async function transferPlayback() {
      await fetch('https://api.spotify.com/v1/me/player', {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ device_ids: [deviceId], play: false })
      });
    }

    async function loadPlaylist() {
      const playlistId = parsePlaylistId(document.getElementById('playlistId').value);
      appendLog('Cargando playlist: ' + playlistId);

      // Paginación de pistas
      tracks = [];
      let url = `playlists/${playlistId}/tracks?fields=items(track(id,name,artists(name),uri)),next&limit=100`;
      while (true) {
        const data = await spotifyApi(url.replace('v1/', '')); // ruta completa si next viene con URL absoluta
        for (const item of data.items) {
          if (item.track && item.track.id) {
            tracks.push({
              id: item.track.id,
              name: item.track.name,
              artists: item.track.artists.map(a => a.name).join(', '),
              uri: `spotify:track:${item.track.id}`
            });
          }
        }
        if (!data.next) break;
        url = data.next;
      }
      appendLog(`Total pistas: ${tracks.length}`);

      // Leer CSV de segmentos (opcional)
      const file = document.getElementById('segmentsCsv').files[0];
      if (file) {
        const text = await file.text();
        segments = {};
        for (const line of text.split(/\\r?\\n/)) {
          const [tid, start, end] = line.split(',');
          if (tid && start && end) {
            segments[tid.trim()] = { start: +start, end: +end };
          }
        }
        appendLog(`Segmentos cargados: ${Object.keys(segments).length}`);
      }

      await transferPlayback();
      appendLog('Playback transferido al Web Player.');
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    async function playTrackUri(uri) {
      await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ uris: [uri] })
      });
    }

    async function seekPosition(ms) {
      await fetch(`https://api.spotify.com/v1/me/player/seek?position_ms=${ms}&device_id=${deviceId}`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}` }
      });
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function startBingo() {
      if (!tracks.length) { appendLog('No hay pistas cargadas.'); return; }
      const order = shuffleArray(tracks);

      for (const t of order) {
        const seg = segments[t.id] || null;
        const startSec = seg ? seg.start : 0;
        const endSec = seg ? seg.end : Math.min(startSec + 20, startSec + 9999); // por defecto 20s

        appendLog(`▶ ${t.name} — ${t.artists}  [${startSec}s → ${endSec}s]`);
        await playTrackUri(t.uri);
        await sleep(800); // pequeño margen para cargar
        await seekPosition(startSec * 1000);

        const durationMs = (endSec - startSec) * 1000;
        await sleep(durationMs);

        // pausar al final del fragmento
        await fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${deviceId}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        logRows.push({
          ts: new Date().toISOString(),
          track: t.name,
          artist: t.artists,
          start: startSec,
          end: endSec
        });
      }

      appendLog('Bingo completado.');
    }

    function downloadLogCsv() {
      const header = 'timestamp,track,artist,start_sec,end_sec\\n';
      const rows = logRows.map(r => `${r.ts},"${r.track.replace(/"/g,'""')}","${r.artist.replace(/"/g,'""')}",${r.start},${r.end}`).join('\\n');
      const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'bingo_log.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // Eventos UI
    document.getElementById('loginBtn').onclick = login;
    document.getElementById('loadPlaylistBtn').onclick = () => { readTokenFromHash(); loadPlaylist().catch(e => appendLog(e.message)); };
    document.getElementById('startBingoBtn').onclick = () => { startBingo().catch(e => appendLog(e.message)); };
    document.getElementById('downloadLogBtn').onclick = downloadLogCsv;

    // Si ya has vuelto del OAuth
    readTokenFromHash();
  </script>
</body>
</html>
